# preprocess-middleware

为Traefik网关开发的一个请求预处理中间件插件

## 功能

- 进行JWT解码：也就是说如果`header`字段`Authorization`中包含`Bearer token`则进行解码验证，验证错误并不响应错误，验证成功则传递给后面真正的服务。只有后面的业务服务才有权限控制是否需要认证。
- 获取会话信息：如果cookie中包含会话ID（字段`sid`），则需要携带会话id向认证服务发起请求，然后将获取的会话信息传递给后面的接口，同样的获取成功或者失败都传递给后面的业务服务，不干预响应。

## Q&A

### 1. 为什么不直接在插件中访问Redis

获取会话信息实际上就是在Redis数据库中检索对应会话id的值然后传递给后面的接口，在插件中直接访问Redis似乎路径更短。

刚开始确实是这么考虑的，但是逐渐发现有一些问题。连接Redis是有一个连接池的，如果每次请求都发起一个连接对性能影响是很大的，但是不太明白在插件中如何初始化并保留连接。而且就算可以保留连接，连接断开后重连也是一个很难处理的问题。同时编写一个单独的接口还能记录查询日志。

